<!DOCTYPE html>
<html>
<head>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <title>MapartCraft</title>
    <meta charset="UTF-8">
    <meta name="description" content="MapartCraft">
    <meta name="author" content="rebane2001">
    <style>
        @import url('https://fonts.googleapis.com/css?family=Open+Sans');
        @import url('https://fonts.googleapis.com/css?family=Lato');
        @font-face {
             font-family: 'kenpixel_mini_square';
             src: url('kenpixel_mini_square.woff') format('woff');
        }  

         html{
             background-color: #333 
        }
        h1,h2{
            margin: 0 0 0 0;
        }
        body {
             font-family: Lato, Open Sans, Arial;
             color: #FFF;
             font-size: 16px;
             margin: 2em auto;
             max-width: 1600px;
             padding: 1em;
             line-height: 1.4;
             text-align: justify 
        }
        a, a:visited {
             color: #7BAE7F 
        }
        [type=radio] { 
          position: absolute;
          opacity: 0;
          width: 0;
          height: 0;
        }
        
        /* IMAGE STYLES */
        [type=radio] + img {
            cursor: pointer;
            margin-top: 3px;
            margin-bottom: 3px;
            margin-right: 3px;
            margin-left: 3px;
            box-shadow: 0px 0px 3px 0px #00000080, inset 0px 0px 40px 0px #00000080;
            -webkit-transition: box-shadow 0.2s; /* Safari */
            transition: box-shadow 0.2s;
        }
        
        /* CHECKED STYLES */
        [type=radio]:checked + img {
          box-shadow: 0px 0px 4px 0px #7BAE7F, inset 0 0 40px 0px #7BAE7F;
          z-index: 10;
        }

        .colorbox {
          float: left;
          width: 16px;
          height: 16px;
          border: 1px solid rgba(0, 0, 0, .2);  
          margin-top: 10px;
          margin-bottom: 12px;
          margin-right: 3px;
          margin-left: 3px;
        }
        #tooltip {
            font-family: 'kenpixel_mini_square';
            position:absolute;
            background:#7BAE7F;
            color:#ffffff;
            padding: 0 7px 2px 7px;
        }
        canvas {
            image-rendering: optimizeSpeed;             /* Older versions of FF          */
            image-rendering: -moz-crisp-edges;          /* FF 6.0+                       */
            image-rendering: -webkit-optimize-contrast; /* Safari                        */
            image-rendering: -o-crisp-edges;            /* OS X & Windows Opera (12.02+) */
            image-rendering: pixelated;                 /* Awesome future-browsers       */
            -ms-interpolation-mode: nearest-neighbor;   /* IE                            */
            cursor: pointer;
        }
        .section {
          margin-bottom: 30px;
          margin-right: 30px;
        }
    </style>
    <script src="js/tooltip.js" type="text/javascript"></script>
    <script src="js/nbt.js" type="text/javascript"></script>
    <script src="js/pako_deflate.min.js" type="text/javascript"></script>
</head>
<body>
<h1>MapartCraft</h1>
<p>A Minecraft mapart schematic generator, designed to be feasible in survival and servers like 2b2t, running in your browser<br>Inspired by <a href="https://redd.it/2yck3f">Redstonehelper's map art program</a>, with the goal to add much-requested features and removing the need to download a program<br>Feel free to message me on Discord (rebane2001#3716) or Reddit (/u/rebane2001)</p>
<div id="blockselection" class="section" style="float: left;">
    <h2>Block selection</h2>
</div>
<div id="mapimage" class="section" style="float: left">
    <h2>Map preview</h2>
    <input type="file" id="imgupload" style="display: none;" /><br>
    <canvas width="128" height="128" id="canvas" style="display: none;"></canvas>
    <canvas width="256" height="256" id="displaycanvas" onclick="chooseFile()" style="float: right;"></canvas><br>
    <small data-tooltip title="A source image with this resolution will work the best" id="mapres">128x69</small>
    <small data-tooltip title="Image doesn't match map's aspect ratio" id="mapreswarning" style="color:red;display: none">1920x1080</small>
</div>
<div id="settings" class="section" style="float: left">
    <h2>Settings</h2>
    <br>
<b>Map size: </b><input id="mapsizex" type="number" min="1" step="1" value="1" style="width: 2em;" onchange="updateMap()">x<input id="mapsizey" type="number" min="1" step="1" value="1" style="width: 2em;" onchange="updateMap()"><br>
<b data-tooltip title="Makes the map 3D. Harder to build, but 3 times the colors!" onclick="updateMap()">Staircasing: <input id="staircasing" type="checkbox" checked></b><br>
<b data-tooltip title="Gives you way better colors at the cost of performance" onclick="updateMap()">Better color: <input id="bettercolor" type="checkbox"></b><br>
<b data-tooltip title="Adds seemingly random pixels for the illusion of more colors" onchange="updateMap()">Dithering: <select id="dither">
  <option>None</option>
  <option selected="selected">Floyd–Steinberg</option>
</select></b><br>
<b>Add blocks under: <select id="underblocks">
  <option>No blocks</option>
  <option selected="selected">Important blocks</option>
  <option>All blocks</option>
</select></b><br>
<b data-tooltip title="Related to previous option">Block to add: <input type="text" id="underblock" value="minecraft:stone"></b><br><br>
<img src="img/download.png" onclick="getNbt()" style="cursor: pointer" /><br>
<form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">
<input type="hidden" name="cmd" value="_s-xclick" />
<input type="hidden" name="hosted_button_id" value="LUNVZPRV7J8J4" />
<input type="image" src="img/donate.png" border="0" name="submit" data-tooltip title="donate" style="cursor: pointer" alt="Donate with PayPal button" />
<img alt="" border="0" src="https://www.paypal.com/en_US/i/scr/pixel.gif" width="1" height="1" />
</form>
</div>

<script>
const blocklist = [
    [[[89, 125, 39], [109, 153, 48], [127, 178, 56], [67, 94, 29]], [["grass","","Grass Block",false,"grass_side"], ["slime","","Slime Block",false,""]]],
    [[[174, 164, 115], [213, 201, 140], [247, 233, 163], [130, 123, 86]], [["sand","","Sand",true,""], ["sandstone","","Sandstone",false,"sandstone_normal"], ["log","'axis':'y','variant':'birch'","Birch Log (vertical)",false,"log_birch_top"], ["planks","'variant':'birch'","Birch Planks",false,"planks_birch"], ["wooden_slab","'variant':'birch'","Birch Slab",false,"slabs_birch"], ["glowstone","","Glowstone",false,""], ["end_stone","","End Stone",false,""]]],
    [[[140, 140, 140], [171, 171, 171], [199, 199, 199], [105, 105, 105]], [["web","","Cobweb",false,""]]],
    [[[180, 0, 0], [220, 0, 0], [255, 0, 0], [135, 0, 0]], [["tnt","","TNT",false,"tnt_side"], ["redstone_block","","Block of Redstone",false,""]]],
    [[[112, 112, 180], [138, 138, 220], [160, 160, 255], [84, 84, 135]], [["ice","","Ice",false,""],["packed_ice","","Packed Ice",false,"ice_packed"]]],
    [[[117, 117, 117], [144, 144, 144], [167, 167, 167], [88, 88, 88]], [["iron_block","","Block of Iron",false,""], ["iron_trapdoor","'half':'bottom'","Iron Trapdoor",true,""], ["heavy_weighted_pressure_plate","","Weighted Pressure Plate (Heavy)",true,""]]],
    [[[0, 87, 0], [0, 106, 0], [0, 124, 0], [0, 65, 0]], [["leaves","","Leaves",false,""]]],
    [[[115, 118, 129], [141, 144, 158], [164, 168, 184], [86, 88, 97]], [["clay","","Clay",false,""]]],
    [[[106, 76, 54], [130, 94, 66], [151, 109, 77], [79, 57, 40]], [["log","'axis':'y','variant':'jungle'","Jungle Log (vertical)",false,"log_jungle_top"], ["planks","'variant':'jungle'","Jungle Planks",false,"planks_jungle"], ["wooden_slab","'variant':'jungle'","Jungle Slab",false,"slabs_jungle"], ["dirt","","Dirte",false,""], ["jukebox","","Jukebox",false,"jukebox_top"], ["stone","'variant':'granite'","Granite",false,"stone_granite"]]],
    [[[79, 79, 79], [96, 96, 96], [112, 112, 112], [59, 59, 59]], [["cobblestone","","Cobblestone",false,""],["stone","","Stone",false,""],["stone_slab","'variant':'stone'","Stone Slab",false,""],["stone_slab","'variant':'cobblestone'","Cobblestone Slab",false,"cobblestone_slab"], ["stone","'variant':'andesite'","Andesite",false,"stone_andesite"], ["bedrock","","Bedrock",false,""], ["log2","'variant':'acacia','axis':'x'","Acacia Log (horizontal)",false,"log_acacia"]]],
    [[[45, 45, 180], [55, 55, 220], [64, 64, 255], [33, 33, 135]], [["water","","Water (Unsupported!)",true,"water_bucket"]]],
    [[[100, 84, 50], [123, 102, 62], [143, 119, 72], [75, 63, 38]], [["log","'axis':'y','variant':'oak'","Oak Log (vertical)",false,"log_oak_top"], ["planks","'variant':'oak'","Oak Planks",false,"planks_oak"], ["wooden_slab","'variant':'oak'","Oak Slab",false,"slabs_oak"], ["crafting_table","","Crafting Table",false,"crafting_table_side"]]],
    [[[180, 177, 172], [220, 217, 211], [255, 252, 245], [135, 133, 129]], [["log","'variant':'birch','axis':'x'","Birch Log (horizontal)",false,"log_birch"], ["stone","'variant':'diorite'","Diorite",false,"stone_diorite"], ["quartz_block","","Quartz Block",false,"quartz_block_side"], ["sea_lantern","","Sea Lantern",false,""]]],
    [[[180, 180, 180], [220, 220, 220], [255, 255, 255], [135, 135, 135]], [["wool","'color':'white'","White Wool",false,"wool_colored_white"],["carpet","'color':'white'","White Carpet",true,"carpet_colored_white"],["stained_glass","'color':'white'","White Stained Glass",true,"glass_white"],["concrete","'color':'white'","White Concrete",false,"concrete_white"],["white_glazed_terracotta","","White Glazed Terracotta",false,"glazed_terracotta_white"], ["snow","","Snow Block",false,""], ["snow_layer","","Snow Layer",true,"snow_layer"]]],
    [[[152, 89, 36], [186, 109, 44], [216, 127, 51], [114, 67, 27]], [["wool","'color':'orange'","Orange Wool",false,"wool_colored_orange"],["carpet","'color':'orange'","Orange Carpet",true,"carpet_colored_orange"],["stained_glass","'color':'orange'","Orange Stained Glass",true,"glass_orange"],["concrete","'color':'orange'","Orange Concrete",false,"concrete_orange"],["orange_glazed_terracotta","","Orange Glazed Terracotta",false,"glazed_terracotta_orange"],["log2","'axis':'y','variant':'acacia'","Acacia Log (vertical)",false,"log_acacia_top"], ["planks","'variant':'acacia'","Acacia Planks",false,"planks_acacia"], ["wooden_slab","'variant':'acacia'","Acacia Slab",false,"slabs_acacia"], ["sand","'variant':'red_sand'","Red Sand",true,"red_sand"], ["red_sandstone","'variant':'red_sandstone'","Red Sandstone",false,"red_sandstone_normal"], ["hardened_clay","","Terracotta",false,""]]],
    [[[125, 53, 152], [153, 65, 186], [178, 76, 216], [94, 40, 114]], [["wool","'color':'magenta'","Magenta Wool",false,"wool_colored_magenta"],["carpet","'color':'magenta'","Magenta Carpet",true,"carpet_colored_magenta"],["stained_glass","'color':'magenta'","Magenta Stained Glass",true,"glass_magenta"],["concrete","'color':'magenta'","Magenta Concrete",false,"concrete_magenta"],["magenta_glazed_terracotta","","Magenta Glazed Terracotta",false,"glazed_terracotta_magenta"],["purpur_block","","Purpur Block",false,""],["purpur_slab","","Purpur Slab",false,""]]],
    [[[72, 108, 152], [88, 132, 186], [102, 153, 216], [54, 81, 114]], [["wool","'color':'light_blue'","Light Blue Wool",false,"wool_colored_light_blue"],["carpet","'color':'light_blue'","Light Blue Carpet",true,"carpet_colored_light_blue"],["stained_glass","'color':'light_blue'","Light Blue Stained Glass",true,"glass_light_blue"],["concrete","'color':'light_blue'","Light Blue Concrete",false,"concrete_light_blue"],["light_blue_glazed_terracotta","","Light Blue Glazed Terracotta",false,"glazed_terracotta_light_blue"]]],
    [[[161, 161, 36], [197, 197, 44], [229, 229, 51], [121, 121, 27]], [["wool","'color':'yellow'","Yellow Wool",false,"wool_colored_yellow"],["carpet","'color':'yellow'","Yellow Carpet",true,"carpet_colored_yellow"],["stained_glass","'color':'yellow'","Yellow Stained Glass",true,"glass_yellow"],["concrete","'color':'yellow'","Yellow Concrete",false,"concrete_yellow"],["yellow_glazed_terracotta","","Yellow Glazed Terracotta",false,"glazed_terracotta_yellow"],["hay_block","","Hay Bale",false,"hay_block_side"],["sponge","","Sponge (any)",false,""]]],
    [[[89, 144, 17], [109, 176, 21], [127, 204, 25], [67, 108, 13]], [["wool","'color':'lime'","Lime Wool",false,"wool_colored_lime"],["carpet","'color':'lime'","Lime Carpet",true,"carpet_colored_lime"],["stained_glass","'color':'lime'","Lime Stained Glass",true,"glass_lime"],["concrete","'color':'lime'","Lime Concrete",false,"concrete_lime"],["lime_glazed_terracotta","","Lime Glazed Terracotta",false,"glazed_terracotta_lime"],["melon_block","","Melon",false,"melon_side"]]],
    [[[170, 89, 116], [208, 109, 142], [242, 127, 165], [128, 67, 87]], [["wool","'color':'pink'","Pink Wool",false,"wool_colored_pink"],["carpet","'color':'pink'","Pink Carpet",true,"carpet_colored_pink"],["stained_glass","'color':'pink'","Pink Stained Glass",true,"glass_pink"],["concrete","'color':'pink'","Pink Concrete",false,"concrete_pink"],["pink_glazed_terracotta","","Pink Glazed Terracotta",false,"glazed_terracotta_pink"]]],
    [[[53, 53, 53], [65, 65, 65], [76, 76, 76], [40, 40, 40]], [["wool","'color':'gray'","Gray Wool",false,"wool_colored_gray"],["carpet","'color':'gray'","Gray Carpet",true,"carpet_colored_gray"],["stained_glass","'color':'gray'","Gray Stained Glass",true,"glass_gray"],["concrete","'color':'gray'","Gray Concrete",false,"concrete_gray"],["gray_glazed_terracotta","","Gray Glazed Terracotta",false,"glazed_terracotta_gray"]]],
    [[[108, 108, 108], [132, 132, 132], [153, 153, 153], [81, 81, 81]], [["wool","'color':'silver'","Light Gray Wool",false,"wool_colored_silver"],["carpet","'color':'silver'","Light Gray Carpet",true,"carpet_colored_silver"],["stained_glass","'color':'silver'","Light Gray Stained Glass",true,"glass_silver"],["concrete","'color':'silver'","Light Gray Concrete",false,"concrete_silver"],["silver_glazed_terracotta","","Light Gray Glazed Terracotta",false,"glazed_terracotta_silver"]]],
    [[[53, 89, 108], [65, 109, 132], [76, 127, 153], [40, 67, 81]], [["wool","'color':'cyan'","Cyan Wool",false,"wool_colored_cyan"],["carpet","'color':'cyan'","Cyan Carpet",true,"carpet_colored_cyan"],["stained_glass","'color':'cyan'","Cyan Stained Glass",true,"glass_cyan"],["concrete","'color':'cyan'","Cyan Concrete",false,"concrete_cyan"],["cyan_glazed_terracotta","","Cyan Glazed Terracotta",false,"glazed_terracotta_cyan"], ["prismarine","","Prismarine",false,""]]],
    [[[89, 44, 125], [109, 54, 153], [127, 63, 178], [67, 33, 94]], [["wool","'color':'purple'","Purple Wool",false,"wool_colored_purple"],["carpet","'color':'purple'","Purple Carpet",true,"carpet_colored_purple"],["stained_glass","'color':'purple'","Purple Stained Glass",true,"glass_purple"],["concrete","'color':'purple'","Purple Concrete",false,"concrete_purple"],["purple_glazed_terracotta","","Purple Glazed Terracotta",false,"glazed_terracotta_purple"],["mycelium","","Mycelium",false,"mycelium_side"]]],
    [[[36, 53, 125], [44, 65, 153], [51, 76, 178], [27, 40, 94]], [["wool","'color':'blue'","Blue Wool",false,"wool_colored_blue"],["carpet","'color':'blue'","Blue Carpet",true,"carpet_colored_blue"],["stained_glass","'color':'blue'","Blue Stained Glass",true,"glass_blue"],["concrete","'color':'blue'","Blue Concrete",false,"concrete_blue"],["blue_glazed_terracotta","","Blue Glazed Terracotta",false,"glazed_terracotta_blue"]]],
    [[[72, 53, 36], [88, 65, 44], [102, 76, 51], [54, 40, 27]], [["wool","'color':'brown'","Brown Wool",false,"wool_colored_brown"],["carpet","'color':'brown'","Brown Carpet",true,"carpet_colored_brown"],["stained_glass","'color':'brown'","Brown Stained Glass",true,"glass_brown"],["concrete","'color':'brown'","Brown Concrete",false,"concrete_brown"],["brown_glazed_terracotta","","Brown Glazed Terracotta",false,"glazed_terracotta_brown"], ["log2","'axis':'y','variant':'dark_oak'","Dark Oak Log (any direction)",false,"log_big_oak"], ["planks","'variant':'dark_oak'","Dark Oak Planks",false,"planks_big_oak"], ["wooden_slab","'variant':'dark_oak'","Dark Oak Slab",false,"slabs_big_oak"], ["log","'variant':'spruce','axis':'x'","Spruce Log (horizontal)",false,"log_spruce"], ["soul_sand","","Soul Sand",false,""]]],
    [[[72, 89, 36], [88, 109, 44], [102, 127, 51], [54, 67, 27]], [["wool","'color':'green'","Green Wool",false,"wool_colored_green"],["carpet","'color':'green'","Green Carpet",true,"carpet_colored_green"],["stained_glass","'color':'green'","Green Stained Glass",true,"glass_green"],["concrete","'color':'green'","Green Concrete",false,"concrete_green"],["green_glazed_terracotta","","Green Glazed Terracotta",false,"glazed_terracotta_green"]]],
    [[[108, 36, 36], [132, 44, 44], [153, 51, 51], [81, 27, 27]], [["wool","'color':'red'","Red Wool",false,"wool_colored_red"],["carpet","'color':'red'","Red Carpet",true,"carpet_colored_red"],["stained_glass","'color':'red'","Red Stained Glass",true,"glass_red"],["concrete","'color':'red'","Red Concrete",false,"concrete_red"],["red_glazed_terracotta","","Red Glazed Terracotta",false,"glazed_terracotta_red"], ["brick_block","","Bricks",false,"brick"], ["nether_wart_block","","Nether Wart Block",false,""]]],
    [[[17, 17, 17], [21, 21, 21], [25, 25, 25], [13, 13, 13]], [["wool","'color':'black'","Black Wool",false,"wool_colored_black"],["carpet","'color':'black'","Black Carpet",true,"carpet_colored_black"],["stained_glass","'color':'black'","Black Stained Glass",true,"glass_black"],["concrete","'color':'black'","Black Concrete",false,"concrete_black"],["black_glazed_terracotta","","Black Glazed Terracotta",false,"glazed_terracotta_black"], ["coal_block","","Block of Coal",false,""], ["obsidian","","Obsidian",false,""]]],
    [[[176, 168, 54], [215, 205, 66], [250, 238, 77], [132, 126, 40]], [["gold_block","","Block of Gold",false,""], ["light_weighted_pressure_plate","","Weighted Pressure Plate (Light)",true,""]]],
    [[[64, 154, 150], [79, 188, 183], [92, 219, 213], [48, 115, 112]], [["diamond_block","","Block of Diamond",false,""], ["prismarine","'variant':'prismarine_bricks'","Prismarine Bricks",false,"prismarine_bricks"], ["prismarine","'variant':'dark_prismarine'","Dark Prismarine",false,"prismarine_dark"], ["beacon","","Beacon",true,""]]],
    [[[52, 90, 180], [63, 110, 220], [74, 128, 255], [39, 67, 135]], [["lapis_block","","Lapis Lazuli Block",false,""]]],
    [[[0, 153, 40], [0, 187, 50], [0, 217, 58], [0, 114, 30]], [["emerald_block","","Block of Emerald",false,""]]],
    [[[91, 60, 34], [111, 74, 42], [129, 86, 49], [68, 45, 25]], [["log","'axis':'y','variant':'spruce'","Spruce Log (vertical)",false,"log_spruce_top"], ["planks","'variant':'spruce'","Spruce Planks",false,"planks_spruce"], ["wooden_slab","'variant':'spruce'","Spruce Slab",false,"slabs_spruce"], ["log","'axis':'x','variant':'oak'","Oak Log (horizontal)",false,"log_oak"], ["log","'axis':'x','variant':'jungle'","Jungle Log (horizontal)",false,"log_jungle"],["dirt","'variant':'podzol'","Podzol",false,"dirt_podzol_side"]]],
    [[[79, 1, 0], [96, 1, 0], [112, 2, 0], [59, 1, 0]], [["netherrack","","Netherrack",false,""], ["nether_brick","","Nether Brick",false,""], ["magma","","Magma Block",false,""]]],
    [[[147, 124, 113], [180, 152, 138], [209, 177, 161], [110, 93, 85]], [["stained_hardened_clay","'color':'white'","White Terracotta",false,"hardened_clay_stained_white"]]],
    [[[112, 57, 25], [137, 70, 31], [159, 82, 36], [84, 43, 19]], [["stained_hardened_clay","'color':'orange'","Orange Terracotta",false,"hardened_clay_stained_orange"]]],
    [[[105, 61, 76], [128, 75, 93], [149, 87, 108], [78, 46, 57]], [["stained_hardened_clay","'color':'magenta'","Magenta Terracotta",false,"hardened_clay_stained_magenta"]]],
    [[[79, 76, 97], [96, 93, 119], [112, 108, 138], [59, 57, 73]], [["stained_hardened_clay","'color':'light_blue'","Light Blue Terracotta",false,"hardened_clay_stained_light_blue"]]],
    [[[131, 93, 25], [160, 114, 31], [186, 133, 36], [98, 70, 19]], [["stained_hardened_clay","'color':'yellow'","Yellow Terracotta",false,"hardened_clay_stained_yellow"]]],
    [[[72, 82, 37], [88, 100, 45], [103, 117, 53], [54, 61, 28]], [["stained_hardened_clay","'color':'lime'","Lime Terracotta",false,"hardened_clay_stained_lime"]]],
    [[[112, 54, 55], [138, 66, 67], [160, 77, 78], [84, 40, 41]], [["stained_hardened_clay","'color':'pink'","Pink Terracotta",false,"hardened_clay_stained_pink"]]],
    [[[40, 28, 24], [49, 35, 30], [57, 41, 35], [30, 21, 18]], [["stained_hardened_clay","'color':'gray'","Gray Terracotta",false,"hardened_clay_stained_gray"]]],
    [[[95, 75, 69], [116, 92, 84], [135, 107, 98], [71, 56, 51]], [["stained_hardened_clay","'color':'silver'","Light Gray Terracotta",false,"hardened_clay_stained_silver"]]],
    [[[61, 64, 64], [75, 79, 79], [87, 92, 92], [46, 48, 48]], [["stained_hardened_clay","'color':'cyan'","Cyan Terracotta",false,"hardened_clay_stained_cyan"]]],
    [[[86, 51, 62], [105, 62, 75], [122, 73, 88], [64, 38, 46]], [["stained_hardened_clay","'color':'purple'","Purple Terracotta",false,"hardened_clay_stained_purple"]]],
    [[[53, 43, 64], [65, 53, 79], [76, 62, 92], [40, 32, 48]], [["stained_hardened_clay","'color':'blue'","Blue Terracotta",false,"hardened_clay_stained_blue"]]],
    [[[53, 35, 24], [65, 43, 30], [76, 50, 35], [40, 26, 18]], [["stained_hardened_clay","'color':'brown'","Brown Terracotta",false,"hardened_clay_stained_brown"]]],
    [[[53, 57, 29], [65, 70, 36], [76, 82, 42], [40, 43, 22]], [["stained_hardened_clay","'color':'green'","Green Terracotta",false,"hardened_clay_stained_green"]]],
    [[[100, 42, 32], [122, 51, 39], [142, 60, 46], [75, 31, 24]], [["stained_hardened_clay","'color':'red'","Red Terracotta",false,"hardened_clay_stained_red"]]],
    [[[26, 15, 11], [31, 18, 13], [37, 22, 16], [19, 11, 8]], [["stained_hardened_clay","'color':'black'","Black Terracotta",false,"hardened_clay_stained_black"]]]
];
var mapsize = [1,1];
var selectedblocks = [];
var selectedcolors = [];
var img = new Image;

function initialize(){
    let colorid = 0;
    blocklist.forEach(function(i) {
        blockid = 0;
        document.getElementById('blockselection').innerHTML += '<br><div class="colorbox" style="background: linear-gradient(' + cssrgb(i[0][0]) + ',' + cssrgb(i[0][1]) + ',' + cssrgb(i[0][2]) + ');"></div><label><input type="radio" name="color' + colorid + '" value="-1" onclick="updateMap()" checked><img src="img/barrier.png" alt="None" data-tooltip title="None"></label>';
        i[1].forEach(function(j) {
            let imgfile = j[4]
            if (j[4] == "")
                imgfile = j[0]
            document.getElementById('blockselection').innerHTML += '<label><input type="radio" name="color' + colorid + '" value="' + blockid + '" onclick="updateMap()"><img src="img/' + imgfile + '.png" alt="' + j[2] + '" data-tooltip title="' + j[2] + '"></label>';
            blockid++;
        });
        colorid++;
    });
    tooltip.refresh();
    document.getElementById('imgupload').addEventListener('change', loadImg);
    img.src = "img/upload.png";
    img.onload = function() {
        updateMap();
    }
}

function updateMap(){
    selectedblocks = [];
    selectedcolors = [];
    for(let i = 0; i < 51; i++){
        blockid = document.querySelector('input[name="color' + i + '"]:checked').value;
        if (blockid == -1){
            continue
        }
        selectedblocks.push([i,parseInt(blockid)]);
        //gotta add 2D/3D support heere
        if (document.getElementById('staircasing').checked){
            selectedcolors.push(blocklist[i][0][0]);
            selectedcolors.push(blocklist[i][0][2]);
        }
        selectedcolors.push(blocklist[i][0][1]);
    }
    mapsize = [document.getElementById('mapsizex').value, document.getElementById('mapsizey').value]
    var canvas = document.getElementById('canvas');
    var ctx = document.getElementById('canvas').getContext('2d');
    var upsctx = document.getElementById('displaycanvas').getContext('2d');
    ctx.canvas.width = mapsize[0]*128;
    ctx.canvas.height = mapsize[1]*128;
    document.getElementById('mapres').innerHTML = ctx.canvas.width + "x" + ctx.canvas.height;
    document.getElementById('mapreswarning').innerHTML = img.width + "x" + img.height;
    if (img.width/img.height == ctx.canvas.width / ctx.canvas.height){
        document.getElementById('mapreswarning').style = "color:red;display: none";
    }else{
        document.getElementById('mapreswarning').style = "color:red;display: inline";
    }
    if (mapsize[0] < 4 && mapsize[1] < 8){
        upsctx.canvas.width = ctx.canvas.width*2;
        upsctx.canvas.height =  ctx.canvas.height*2;
    }else{
        upsctx.canvas.width = ctx.canvas.width;
        upsctx.canvas.height =  ctx.canvas.height;
    }
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    var imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
    for(var i=0; i<imgData.data.length; i+=4) {
        //i = r, i+1 = g, i+2 = b, i+3 = a
        imgData.data[i+3] = 255; //remove alpha
        switch(document.getElementById("dither").selectedIndex){
            case 0: //no dither
                newpixel = find_closest([imgData.data[i],imgData.data[i+1],imgData.data[i+2]])
                imgData.data[i+0] = newpixel[0];
                imgData.data[i+1] = newpixel[1];
                imgData.data[i+2] = newpixel[2];
                break;
            case 1: //floyd
                oldpixel = [imgData.data[i],imgData.data[i+1],imgData.data[i+2]];
                newpixel = find_closest(oldpixel);
                quant_error = [];
                for(var j = 0;j<=3;j++)
                    quant_error.push(oldpixel[j] - newpixel[j]);
                imgData.data[i+0] = newpixel[0];
                imgData.data[i+1] = newpixel[1];
                imgData.data[i+2] = newpixel[2];
                try {
                    imgData.data[i+4] += (quant_error[0]*7/16);
                    imgData.data[i+5] += (quant_error[1]*7/16);
                    imgData.data[i+6] += (quant_error[2]*7/16);
                    imgData.data[i+canvas.width*4-4] += (quant_error[0]*3/16);
                    imgData.data[i+canvas.width*4-3] += (quant_error[1]*3/16);
                    imgData.data[i+canvas.width*4-2] += (quant_error[2]*3/16);
                    imgData.data[i+canvas.width*4+0] += (quant_error[0]*5/16);
                    imgData.data[i+canvas.width*4+1] += (quant_error[1]*5/16);
                    imgData.data[i+canvas.width*4+2] += (quant_error[2]*5/16);
                    imgData.data[i+canvas.width*4+4] += (quant_error[0]*1/16);
                    imgData.data[i+canvas.width*4+5] += (quant_error[1]*1/16);
                    imgData.data[i+canvas.width*4+6] += (quant_error[2]*1/16);
                }catch(e) {}
                break;
        }
        let x = (i/4) % canvas.width;
        let y = ((i/4) - x) / canvas.width;
        upsctx.fillStyle = "rgba("+imgData.data[i+0]+","+imgData.data[i+1]+","+imgData.data[i+2]+","+255+")";
        if (mapsize[0] < 4 && mapsize[1] < 8)
            upsctx.fillRect(x*2,y*2,2,2);
        else
            upsctx.fillRect(x,y,1,1);
    }
    ctx.putImageData(imgData, 0, 0);
}

function getNbt(){
    var ctx = document.getElementById('canvas').getContext('2d');
    var imgData = ctx.getImageData(0,0,ctx.canvas.width,ctx.canvas.height);
    var blocks = []
    nbtblocklist = []
    let underblocks = document.getElementById("underblocks").selectedIndex;
    if (underblocks > 0){
        let underblock = document.getElementById("underblock").value;
        nbtblocklist.push({"Colors":[-1,-1,-1],"Name":underblock});
    }
    for (let x = 0;x < ctx.canvas.width;x++){
        for (let y = 0;y < ctx.canvas.height;y++){
            color = [imgData.data[x*4 + y*4*ctx.canvas.width],imgData.data[x*4 + y*4*ctx.canvas.width + 1],imgData.data[x*4 + y*4*ctx.canvas.width + 2]];
            selectedblocks.forEach(function(i) {
                if (arraysEqual(blocklist[i[0]][0][0], color) ||arraysEqual(blocklist[i[0]][0][1], color) || arraysEqual(blocklist[i[0]][0][2], color)){
                    if (blocklist[i[0]][1][i[1]][1] == ""){
                        toPush = {"Colors":blocklist[i[0]][0],"Name":"minecraft:" + blocklist[i[0]][1][i[1]][0]};
                    }else{
                        toPush = {"Colors":blocklist[i[0]][0],"Name":"minecraft:" + blocklist[i[0]][1][i[1]][0], "Properties": JSON.parse("{ " + blocklist[i[0]][1][i[1]][1].replace(/'/g, "\"") + " }")};
                    }
                    try {
                    nbtblocklist.forEach(function(j) { //what the fuck even
                        if (arraysEqual(j["Colors"],toPush["Colors"])){
                            toPush = null;
                            throw 69;
                        }
                    });
                    }catch(err) {}
                    if (toPush != null)
                        nbtblocklist.push(toPush);
                }
            });
        }
    }
    let maxheight = [0,2];
    if (document.getElementById('staircasing').checked){ //3D CODE
        for (let x = 0;x < ctx.canvas.width;x++){

            let hhhh = 1000;
            let minh = 1000;
            let maxh = 1000;
            for (let y = 0;y < ctx.canvas.height;y++){
                let color = [imgData.data[x*4 + y*4*ctx.canvas.width],imgData.data[x*4 + y*4*ctx.canvas.width + 1],imgData.data[x*4 + y*4*ctx.canvas.width + 2]];
                let toneid = 0;
                for (let i = 0; i < nbtblocklist.length; i++) {
                    if (arraysEqual(nbtblocklist[i]["Colors"][0], color)){
                        toneid = -1;
                        break;
                    }
                    if (arraysEqual(nbtblocklist[i]["Colors"][1], color)){
                        toneid = 0;
                        break;
                    }
                    if (arraysEqual(nbtblocklist[i]["Colors"][2], color)){
                        toneid = 1;
                        break;
                    }

                }
                hhhh += toneid;
                minh = Math.min(minh,hhhh);
                maxh = Math.max(maxh,hhhh);
            }
            maxheight = [Math.min(maxheight[0],minh),Math.max(maxheight[1],maxh+2)];
            hhhh = 1000-minh;
            hhhh += 2;
            for (let y = 0;y < ctx.canvas.height;y++){
                let color = [imgData.data[x*4 + y*4*ctx.canvas.width],imgData.data[x*4 + y*4*ctx.canvas.width + 1],imgData.data[x*4 + y*4*ctx.canvas.width + 2]];
                let toneid = 0;
                let blockid = 0;
                for (let i = 0; i < nbtblocklist.length; i++) {
                    if (arraysEqual(nbtblocklist[i]["Colors"][0], color)){
                        toneid = -1;
                        blockid = i;
                        break;
                    }
                    if (arraysEqual(nbtblocklist[i]["Colors"][1], color)){
                        toneid = 0;
                        blockid = i;
                        break;
                    }
                    if (arraysEqual(nbtblocklist[i]["Colors"][2], color)){
                        toneid = 1;
                        blockid = i;
                        break;
                    }
                }
                if (y == 0){
                    blocks.push({"pos":[x,hhhh-toneid,y],"state":0});  
                }
                hhhh += toneid;
                blocks.push({"pos":[x,hhhh,y+1],"state":blockid});  
                console.log(hhhh);
                //UNDERBLOCKS
                if (underblocks == 2){
                    blocks.push({"pos":[x,hhhh - 1,y+1],"state":0});  
                }else if(underblocks == 1){
                    selectedblocks.forEach(function(b) {
                        if (arraysEqual(blocklist[b[0]][0][0], nbtblocklist[blockid]["Colors"][0])){
                            if (blocklist[b[1]][1][3])
                                blocks.push({"pos":[x,hhhh - 1,y+1],"state":0});  
                       }
                    });
                }  

            }
        }
    }else{ //2D CODE
         for (let x = 0;x < ctx.canvas.width;x++){
            for (let y = 0;y < ctx.canvas.height;y++){
                let color = [imgData.data[x*4 + y*4*ctx.canvas.width],imgData.data[x*4 + y*4*ctx.canvas.width + 1],imgData.data[x*4 + y*4*ctx.canvas.width + 2]];
                let blockid = 0;
                for (let i = 0; i < nbtblocklist.length; i++) {
                    if (arraysEqual(nbtblocklist[i]["Colors"][1], color)){
                        blockid = i;
                        break;
                    }
                }
                blocks.push({"pos":[x,1,y+1],"state":blockid});    
                //UNDERBLOCKS
                if (underblocks == 2){
                    blocks.push({"pos":[x,0,y+1],"state":0});  
                }else if(underblocks == 1){
                    selectedblocks.forEach(function(b) {
                        if (arraysEqual(blocklist[b[0]][0][0], nbtblocklist[blockid]["Colors"][0])){
                            if (blocklist[b[1]][1][3])
                                blocks.push({"pos":[x,0,y+1],"state":0});  
                       }
                    });
                }  
            }
        }
    }
    //edit SIZE parameter!!!
    //return {"blocks":blocks,"entities":{},"palette":nbtblocklist,"size":[ctx.canvas.width,2,ctx.canvas.height],"author":"rebane2001.com/mapartcraft","DataVersion":1343};
    jsonstring = "{\"name\":\"\",\"value\":{\"blocks\":{\"type\":\"list\",\"value\":{\"type\":\"compound\",\"value\":[";
    blocks.forEach(function(r) {
        jsonstring += "{\"pos\":{\"type\":\"list\",\"value\":{\"type\":\"int\",\"value\":[" + r["pos"][0] + "," + r["pos"][1] + "," + r["pos"][2] + "]}},\"state\":{\"type\":\"int\",\"value\":" + r["state"] +  "}},";
    });
    jsonstring = jsonstring.slice(0, -1);
    jsonstring += "]}},\"entities\":{\"type\":\"list\",\"value\":{\"type\":\"compound\",\"value\":[]}},\"palette\":{\"type\":\"list\",\"value\":{\"type\":\"compound\",\"value\":[";
    nbtblocklist.forEach(function(r) {
        if ("Properties" in r){
                jsonstring += "{\"Properties\":{\"type\":\"compound\",\"value\":{";
                Object.keys(r["Properties"]).forEach(function(t) {
                jsonstring +=  "\"" + t + "\":{\"type\":\"string\",\"value\":\"" + r["Properties"][t] + "\"},";
            });
        jsonstring = jsonstring.slice(0, -1);
        jsonstring += "}}, \"Name\":{\"type\":\"string\",\"value\":\"" + r["Name"] + "\"}},";
        }else{
            jsonstring += "{\"Name\":{\"type\":\"string\",\"value\":\"" + r["Name"] + "\"}},";
        }
    });
    maxheight = maxheight[1] - maxheight[0];
    jsonstring = jsonstring.slice(0, -1) + "]}},\"size\":{\"type\":\"list\",\"value\":{\"type\":\"int\",\"value\":[" + ctx.canvas.width + "," + maxheight + "," + (ctx.canvas.height+1) + "]}},\"author\":{\"type\":\"string\",\"value\":\"rebane2001.com/mapartcraft\"},\"DataVersion\":{\"type\":\"int\",\"value\":1343}}}";
    //download
    console.log("Parsing JSON and converting to NBT");
    let nbtdata = nbt.writeUncompressed(JSON.parse(jsonstring));
    console.log("Gzipping");
    let gzipped = pako.gzip(nbtdata);
    console.log("Blobbing");
    let blob = new Blob([gzipped], {type: 'application/x-minecraft-level'});
    let a = document.createElement("a");
    document.body.appendChild(a);
    a.style = "display: none";
    url = window.URL.createObjectURL(blob);
    a.href = url;
    a.download = "mapart.nbt";
    a.click();
    window.URL.revokeObjectURL(url);
}

/*
function diff_colors(p1,p2){
    r = p1[0] - p2[0];
    g = p1[1] - p2[1];
    b = p1[2] - p2[2];
    return Math.sqrt(r*r+g*g+b*b)
}
*/
/*
function diff_colors(p1,p2){
    rmean = ( p1[0] + p2[0] ) / 2;
    r = p1[0] - p2[0];
    g = p1[1] - p2[1];
    b = p1[2] - p2[2];
    return (((512+rmean)*r*r)>>8) + 4*g*g + (((767-rmean)*b*b)>>8)
}
*/
function diff_colors(p1,p2){
    if (document.getElementById('bettercolor').checked){
        //return deltaE(rgb2lab(p1),rgb2lab(p2))
        p1 = rgb2lab(p1);
        p2 = rgb2lab(p2);
    }
    r = p1[0] - p2[0];
    g = p1[1] - p2[1];
    b = p1[2] - p2[2];
    return r*r+g*g+b*b
}

function find_closest(pixel){
    bestval = 9999999;
    newpixel = pixel;
    selectedcolors.forEach(function(p) {
        if (diff_colors(p,pixel) < bestval){
            bestval = diff_colors(p,pixel);
            newpixel = p;
        }
    });
    return newpixel;
}

function loadImg(e) {
    img = new Image;
    img.src = URL.createObjectURL(e.target.files[0]);
    img.onload = function() {
        updateMap();
    }
}

function chooseFile() {
    document.getElementById("imgupload").click();
}

//Thx
//stackoverflow.com/a/16436975
function arraysEqual(a, b) {
  if (a === b) return true;
  if (a == null || b == null) return false;
  if (a.length != b.length) return false;

  // If you don't care about the order of the elements inside
  // the array, you should sort both arrays here.
  // Please note that calling sort on an array will modify that array.
  // you might want to clone your array first.

  for (var i = 0; i < a.length; ++i) {
    if (a[i] !== b[i]) return false;
  }
  return true;
}

//rgb2lab conversion based on the one from redstonehelper's program
function rgb2lab(rgb){
  var r1 = rgb[0] / 255.0,
      g1 = rgb[1] / 255.0,
      b1 = rgb[2] / 255.0;
        f = 0.008856452;
        f2 = 903.2963;
        f3 = 0.964221;
        f4 = 1.0;
        f5 = 0.825211;

        r1 = r1 <= 0.04045 ? (r1 /= 12.0) : Math.pow((r1 + 0.055) / 1.055, 2.4);
        g1 = g1 <= 0.04045 ? (g1 /= 12.0) : Math.pow((g1 + 0.055) / 1.055, 2.4);
        b1 = b1 <= 0.04045 ? (b1 /= 12.0) : Math.pow((b1 + 0.055) / 1.055, 2.4);

        f9 = 0.43605202 * r1 + 0.3850816 * g1 + 0.14308742 * b1;
        f10 = 0.22249159 * r1 + 0.71688604 * g1 + 0.060621485 * b1;
        f11 = 0.013929122 * r1 + 0.097097 * g1 + 0.7141855 * b1;
        f12 = f9 / f3;
        f13 = f10 / f4;
        f14 = f11 / f5;
        f15 = f12 > f ? Math.pow(f12, 1/3) : (((f2 * f12) + 16.0) / 116.0);
        f16 = f13 > f ? Math.pow(f13, 1/3) : (((f2 * f13) + 16.0) / 116.0);
        f17 = f14 > f ? Math.pow(f14, 1/3) : (((f2 * f14) + 16.0) / 116.0);
        f18 = 116.0 * f16 - 16.0;
        f19 = 500.0 * (f15 - f16);
        f20 = 200.0 * (f16 - f17);
        r = parseInt(2.55 * f18 + 0.5);
        g = parseInt(f19 + 0.5);
        b = parseInt(f20 + 0.5);
        return [r,g,b];
}

/*

This is some RGB/LAB code I used earlier. I'm leaving it here in case I ever need it again

//Thx antimatter15
//github.com/antimatter15/rgb-lab/blob/master/color.js
function rgb2lab2(rgb){
  var r = rgb[0] / 255,
      g = rgb[1] / 255,
      b = rgb[2] / 255,
      x, y, z;

    xyz = RGBtoXYZ(r,g,b);
    x = xyz[0];
    y = xyz[1];
    z = xyz[2];
    return (XYZtoLAB(x,y,z));

  r = (r > 0.04045) ? Math.pow((r + 0.055) / 1.055, 2.4) : r / 12.92;
  g = (g > 0.04045) ? Math.pow((g + 0.055) / 1.055, 2.4) : g / 12.92;
  b = (b > 0.04045) ? Math.pow((b + 0.055) / 1.055, 2.4) : b / 12.92;

  x = (r * 0.4124 + g * 0.3576 + b * 0.1805) / 0.95047;
  y = (r * 0.2126 + g * 0.7152 + b * 0.0722) / 1.00000;
  z = (r * 0.0193 + g * 0.1192 + b * 0.9505) / 1.08883;

  x = (x > 0.008856) ? Math.pow(x, 1/3) : (7.787 * x) + 16/116;
  y = (y > 0.008856) ? Math.pow(y, 1/3) : (7.787 * y) + 16/116;
  z = (z > 0.008856) ? Math.pow(z, 1/3) : (7.787 * z) + 16/116;

  return [(116 * y) - 16, 500 * (x - y), 200 * (y - z)]
}

//Thx THEjoezack
//github.com/THEjoezack/ColorMine/blob/master/ColorMine/ColorSpaces/Comparisons/Cie94Comparison.cs
function deltaE(labA, labB){
  var deltaL = labA[0] - labB[0];
  var deltaA = labA[1] - labB[1];
  var deltaB = labA[2] - labB[2];
  var c1 = Math.sqrt(labA[1] * labA[1] + labA[2] * labA[2]);
  var c2 = Math.sqrt(labB[1] * labB[1] + labB[2] * labB[2]);
  var deltaC = c1 - c2;
  var deltaH = deltaA * deltaA + deltaB * deltaB - deltaC * deltaC;
  deltaH = deltaH < 0 ? 0 : Math.sqrt(deltaH);
  var sc = 1.0 + 0.045 * c1;
  var sh = 1.0 + 0.015 * c1;
  var deltaLKlsl = deltaL / (1.0);
  var deltaCkcsc = deltaC / (sc);
  var deltaHkhsh = deltaH / (sh);
  var i = deltaLKlsl * deltaLKlsl + deltaCkcsc * deltaCkcsc + deltaHkhsh * deltaHkhsh;
  return i < 0 ? 0 : Math.sqrt(i);
}

function RGBtoXYZ(R, G, B)
{
    var_R = parseFloat( R / 255 )        //R from 0 to 255
    var_G = parseFloat( G / 255 )        //G from 0 to 255
    var_B = parseFloat( B / 255 )        //B from 0 to 255

    var_R = Math.pow(var_R, 2.19921875);
    var_G = Math.pow(var_G, 2.19921875);
    var_B = Math.pow(var_B, 2.19921875);

    var_R = var_R * 100
    var_G = var_G * 100
    var_B = var_B * 100

    //Observer. = 2°, Illuminant = D65
    X = var_R * 0.57667 + var_G * 0.18555 + var_B * 0.18819
    Y = var_R * 0.29738 + var_G * 0.62735 + var_B * 0.07527
    Z = var_R * 0.02703 + var_G * 0.07069 + var_B * 0.99110
    return [X, Y, Z]
}

function RGBtoXYZ2(R, G, B)
{
    var_R = parseFloat( R / 255 )        //R from 0 to 255
    var_G = parseFloat( G / 255 )        //G from 0 to 255
    var_B = parseFloat( B / 255 )        //B from 0 to 255

    if ( var_R > 0.04045 ) var_R = Math.pow(( ( var_R + 0.055 ) / 1.055 ), 2.4)
    else                   var_R = var_R / 12.92
    if ( var_G > 0.04045 ) var_G = Math.pow(( ( var_G + 0.055 ) / 1.055 ), 2.4)
    else                   var_G = var_G / 12.92
    if ( var_B > 0.04045 ) var_B = Math.pow(( ( var_B + 0.055 ) / 1.055 ), 2.4)
    else                   var_B = var_B / 12.92

    var_R = var_R * 100
    var_G = var_G * 100
    var_B = var_B * 100

    //Observer. = 2°, Illuminant = D65
    X = var_R * 0.4124 + var_G * 0.3576 + var_B * 0.1805
    Y = var_R * 0.2126 + var_G * 0.7152 + var_B * 0.0722
    Z = var_R * 0.0193 + var_G * 0.1192 + var_B * 0.9505
    return [X, Y, Z]
}


function XYZtoLAB(x, y, z)
{
    var ref_X =  95.047;
    var ref_Y = 100.000;
    var ref_Z = 108.883;

    var_X = x / ref_X          //ref_X =  95.047   Observer= 2°, Illuminant= D65
    var_Y = y / ref_Y          //ref_Y = 100.000
    var_Z = z / ref_Z          //ref_Z = 108.883

    if ( var_X > 0.008856 ) var_X = Math.pow(var_X, ( 1/3 ))
    else                    var_X = ( 7.787 * var_X ) + ( 16 / 116 )
    if ( var_Y > 0.008856 ) var_Y = Math.pow(var_Y, ( 1/3 ))
    else                    var_Y = ( 7.787 * var_Y ) + ( 16 / 116 )
    if ( var_Z > 0.008856 ) var_Z = Math.pow(var_Z, ( 1/3 ))
    else                    var_Z = ( 7.787 * var_Z ) + ( 16 / 116 )

    CIE_L = ( 116 * var_Y ) - 16
    CIE_a = 500 * ( var_X - var_Y )
    CIE_b = 200 * ( var_Y - var_Z )

return [CIE_L, CIE_a, CIE_b]
}
*/

//Thx Alexander O'Mara
//stackoverflow.com/a/41310924
function cssrgb(values) {
    return 'rgb(' + values.join(', ') + ')';
}


initialize();
</script>
</body>
</html>